PLAYER  = game.Players.LocalPlayer
MOUSE   = PLAYER:GetMouse()
CC      = game.Workspace.CurrentCamera

ENABLED = false
LOCKED_ON_TARGET = nil

_G.FREE_FOR_ALL = false  -- Set this to false for team-based gameplay

_G.AIM_AT = 'Head'

wait(1)

function GetNearestPlayerToMouse()
	local PLAYERS      = {}
	local PLAYER_HOLD  = {}
	local DISTANCES    = {}
	for i, v in pairs(game.Players:GetPlayers()) do
		if v ~= PLAYER and v.Team ~= PLAYER.Team then  -- Check if the player is not on the same team
			table.insert(PLAYERS, v)
		end
	end
	for i, v in pairs(PLAYERS) do
		if v and v.Character then
			local AIM = v.Character:FindFirstChild(_G.AIM_AT)
			if AIM ~= nil then
				local DISTANCE                 = (AIM.Position - CC.CoordinateFrame.p).magnitude
				local RAY                      = Ray.new(CC.CoordinateFrame.p, (MOUSE.Hit.p - CC.CoordinateFrame.p).unit * DISTANCE)
				local HIT,POS                  = game.Workspace:FindPartOnRay(RAY, game.Workspace)
				local DIFF                     = math.floor((POS - AIM.Position).magnitude)
				PLAYER_HOLD[v.Name .. i]       = {}
				PLAYER_HOLD[v.Name .. i].dist  = DISTANCE
				PLAYER_HOLD[v.Name .. i].plr   = v
				PLAYER_HOLD[v.Name .. i].diff  = DIFF
				table.insert(DISTANCES, DIFF)
			end
		end
	end

	if unpack(DISTANCES) == nil then
		return false
	end

	local L_DISTANCE = math.floor(math.min(unpack(DISTANCES)))
	if L_DISTANCE > 20 then
		return false
	end

	for i, v in pairs(PLAYER_HOLD) do
		if v.diff == L_DISTANCE then
			return v.plr
		end
	end
	return false
end

function LockOnCharacter(target)
	if target then
		local AIM = target.Character:FindFirstChild(_G.AIM_AT)
		if AIM then
			CC.CoordinateFrame = CFrame.new(CC.CoordinateFrame.p, AIM.CFrame.p)
		end
		GUI_TARGET.Text = 'AIMBOT : '.. target.Name:sub(1, 5)
	else
		GUI_TARGET.Text = 'AIMBOT : OFF'
	end
end

-- GUI Creation
GUI_MAIN                           = Instance.new('ScreenGui', game.CoreGui)
GUI_TARGET                         = Instance.new('TextLabel', GUI_MAIN)

-- Invisible Button at Top Middle
AIMBOT_BUTTON                      = Instance.new('TextButton', GUI_MAIN)

GUI_MAIN.Name                      = 'AIMBOT'

GUI_TARGET.Size                    = UDim2.new(0,200,0,30)
GUI_TARGET.BackgroundTransparency  = 0.5
GUI_TARGET.BackgroundColor         = BrickColor.new('Fossil')
GUI_TARGET.BorderSizePixel         = 0
GUI_TARGET.Position                = UDim2.new(0.5,-100,0,0)  -- Position at the top middle
GUI_TARGET.Text                    = 'AIMBOT : OFF'
GUI_TARGET.TextColor3              = Color3.new(1,1,1)
GUI_TARGET.TextStrokeTransparency  = 1
GUI_TARGET.TextWrapped             = true
GUI_TARGET.FontSize                = 'Size24'
GUI_TARGET.Font                    = 'SourceSansBold'

-- Invisible Button at Top Middle
AIMBOT_BUTTON.Size                 = UDim2.new(0, 200, 0, 30)  -- Same size as the text label
AIMBOT_BUTTON.Position             = UDim2.new(0.5, -100, 0, 0)  -- Top middle
AIMBOT_BUTTON.BackgroundTransparency = 1  -- Make the button invisible
AIMBOT_BUTTON.Text                 = ""  -- No text for the button

local function ToggleAimbot()
	ENABLED = not ENABLED
	if ENABLED then
		GUI_TARGET.Text = "AIMBOT : ON"
	else
		GUI_TARGET.Text = "AIMBOT : OFF"
		LOCKED_ON_TARGET = nil  -- Unlock when disabled
	end
end

-- Aimbot toggle via invisible button at top middle
AIMBOT_BUTTON.MouseButton1Click:Connect(function()
	ToggleAimbot()
end)

function UnlockOnMove()
	-- Unlock target when camera moves too far away from the target
	if LOCKED_ON_TARGET and (CC.CoordinateFrame.p - LOCKED_ON_TARGET.Character[_G.AIM_AT].Position).magnitude > 20 then
		LOCKED_ON_TARGET = nil
		GUI_TARGET.Text = 'AIMBOT : OFF'
	end
end

game:GetService('RunService').RenderStepped:connect(function()
	if ENABLED then
		if LOCKED_ON_TARGET then
			if LOCKED_ON_TARGET.Character and LOCKED_ON_TARGET.Character:FindFirstChild(_G.AIM_AT) then
				LockOnCharacter(LOCKED_ON_TARGET)
			else
				LOCKED_ON_TARGET = nil  -- Unlock if the target dies or disappears
				GUI_TARGET.Text = 'AIMBOT : OFF'
			end
		else
			local TARGET = GetNearestPlayerToMouse()
			if TARGET ~= false then
				LOCKED_ON_TARGET = TARGET  -- Lock onto this target
			end
		end
		UnlockOnMove()  -- Check if camera moved too far to unlock
	end
end)
