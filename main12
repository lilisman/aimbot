PLAYER  = game.Players.LocalPlayer
MOUSE   = PLAYER:GetMouse()
CC      = game.Workspace.CurrentCamera

ENABLED = false
LOCKED_ON_TARGET = nil
MANUAL_UNLOCK = false  -- To track if the camera forced an unlock

_G.FREE_FOR_ALL = false  -- Set this to false for team-based gameplay
_G.AIM_AT = 'Head'

wait(1)

-- Function to get the nearest player
function GetNearestPlayerToMouse()
	local PLAYERS      = {}
	local PLAYER_HOLD  = {}
	local DISTANCES    = {}
	for i, v in pairs(game.Players:GetPlayers()) do
		if v ~= PLAYER and v.Team ~= PLAYER.Team then  -- Ensure not targeting teammates
			table.insert(PLAYERS, v)
		end
	end
	for i, v in pairs(PLAYERS) do
		if v and v.Character and v.Character:FindFirstChild(_G.AIM_AT) then
			local AIM = v.Character[_G.AIM_AT]
			local DISTANCE = (AIM.Position - CC.CoordinateFrame.p).magnitude
			table.insert(PLAYER_HOLD, {player = v, distance = DISTANCE})
		end
	end

	if #PLAYER_HOLD == 0 then
		return nil
	end

	table.sort(PLAYER_HOLD, function(a, b)
		return a.distance < b.distance
	end)

	return PLAYER_HOLD[1].player  -- Return the nearest player
end

-- Function to lock onto a character
function LockOnCharacter(target)
	if target and target.Character then
		local AIM = target.Character:FindFirstChild(_G.AIM_AT)
		if AIM then
			CC.CoordinateFrame = CFrame.new(CC.CoordinateFrame.p, AIM.CFrame.p)
		end
		GUI_TARGET.Text = 'AIMBOT : ' .. target.Name:sub(1, 5)
	else
		GUI_TARGET.Text = 'AIMBOT : OFF'
	end
end

-- GUI Creation
GUI_MAIN                           = Instance.new('ScreenGui', game.CoreGui)
GUI_TARGET                         = Instance.new('TextLabel', GUI_MAIN)
AIMBOT_BUTTON                      = Instance.new('TextButton', GUI_MAIN)

GUI_MAIN.Name                      = 'AIMBOT'

GUI_TARGET.Size                    = UDim2.new(0,200,0,30)
GUI_TARGET.BackgroundTransparency  = 0.5
GUI_TARGET.BackgroundColor         = BrickColor.new('Fossil')
GUI_TARGET.BorderSizePixel         = 0
GUI_TARGET.Position                = UDim2.new(0.5,-100,0,0)  -- Position at the top middle
GUI_TARGET.Text                    = 'AIMBOT : OFF'
GUI_TARGET.TextColor3              = Color3.new(1,1,1)
GUI_TARGET.TextStrokeTransparency  = 1
GUI_TARGET.TextWrapped             = true
GUI_TARGET.FontSize                = 'Size24'
GUI_TARGET.Font                    = 'SourceSansBold'

-- Invisible Button at Top Middle
AIMBOT_BUTTON.Size                 = UDim2.new(0, 200, 0, 30)  -- Same size as the text label
AIMBOT_BUTTON.Position             = UDim2.new(0.5, -100, 0, 0)  -- Top middle
AIMBOT_BUTTON.BackgroundTransparency = 1  -- Make the button invisible
AIMBOT_BUTTON.Text                 = ""  -- No text for the button

-- Toggle aimbot
local function ToggleAimbot()
	ENABLED = not ENABLED
	if ENABLED then
		GUI_TARGET.Text = "AIMBOT : ON"
	else
		LOCKED_ON_TARGET = nil  -- Unlock when disabled
		GUI_TARGET.Text = "AIMBOT : OFF"
	end
end

-- Aimbot toggle via invisible button at top middle
AIMBOT_BUTTON.MouseButton1Click:Connect(function()
	ToggleAimbot()
end)

-- Manual unlock logic when camera moves too far from the target
function CheckManualUnlock()
	if LOCKED_ON_TARGET and LOCKED_ON_TARGET.Character and LOCKED_ON_TARGET.Character:FindFirstChild(_G.AIM_AT) then
		local AIM = LOCKED_ON_TARGET.Character[_G.AIM_AT]
		local DISTANCE = (AIM.Position - CC.CoordinateFrame.p).magnitude
		if DISTANCE > 50 then  -- If camera moves too far, unlock
			LOCKED_ON_TARGET = nil
			MANUAL_UNLOCK = true
			GUI_TARGET.Text = 'AIMBOT : OFF'
		end
	end
end

game:GetService('RunService').RenderStepped:connect(function()
	if ENABLED then
		-- If no locked target and aimbot is still enabled, find the nearest player
		if not LOCKED_ON_TARGET and not MANUAL_UNLOCK then
			local TARGET = GetNearestPlayerToMouse()
			if TARGET then
				LOCKED_ON_TARGET = TARGET
				GUI_TARGET.Text = "AIMBOT : " .. TARGET.Name
			end
		end
		
		-- If we have a locked target, keep locking on to them
		if LOCKED_ON_TARGET then
			LockOnCharacter(LOCKED_ON_TARGET)
			-- If target dies, unlock
			if LOCKED_ON_TARGET.Character:FindFirstChild("Humanoid").Health <= 0 then
				LOCKED_ON_TARGET = nil
				GUI_TARGET.Text = "AIMBOT : OFF"
			end
		end
		
		CheckManualUnlock()  -- Check if camera forced unlock
		
		-- Re-lock if camera is back on a player
		if MANUAL_UNLOCK and LOCKED_ON_TARGET == nil then
			local TARGET = GetNearestPlayerToMouse()
			if TARGET then
				LOCKED_ON_TARGET = TARGET
				MANUAL_UNLOCK = false  -- Reset manual unlock status
				GUI_TARGET.Text = "AIMBOT : " .. TARGET.Name
			end
		end
	end
end)
